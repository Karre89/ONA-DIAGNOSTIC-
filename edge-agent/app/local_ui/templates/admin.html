{% extends "base.html" %}

{% block title %}{{ t.get('admin', 'Admin') }} - Ona Edge{% endblock %}

{% block content %}
<h2 style="margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600;">
    {{ t.get('system_status', 'System Status') }}
</h2>

<div class="stats-grid" style="margin-bottom: 1.5rem;">
    <div class="stat-card">
        <div class="stat-value" style="color: var(--success);">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 0.5rem;">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        </div>
        <div class="stat-label">{{ t.get('edge_status', 'Edge Status') }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ sync_stats.pending }}</div>
        <div class="stat-label">{{ t.get('sync_pending', 'Sync Queue') }}</div>
    </div>
    <div class="stat-card" {% if sync_stats.failed > 0 %}class="high"{% endif %}>
        <div class="stat-value">{{ sync_stats.failed }}</div>
        <div class="stat-label">{{ t.get('sync_failed', 'Failed') }}</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
    <div class="card">
        <div class="card-header">{{ t.get('device_info', 'Device Information') }}</div>

        {% if device_state and device_state.device_id %}
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <span style="color: var(--text-muted);">{{ t.get('device_id', 'Device ID') }}</span>
                <span style="font-family: 'Monaco', monospace; color: var(--accent);">{{ device_state.device_id[:8] }}...</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <span style="color: var(--text-muted);">{{ t.get('tenant_id', 'Tenant') }}</span>
                <span style="font-family: 'Monaco', monospace;">{{ device_state.tenant_id[:8] if device_state.tenant_id else '-' }}...</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <span style="color: var(--text-muted);">{{ t.get('site_id', 'Site') }}</span>
                <span style="font-family: 'Monaco', monospace;">{{ device_state.site_id[:8] if device_state.site_id else '-' }}...</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <span style="color: var(--text-muted);">{{ t.get('registered', 'Registered') }}</span>
                <span>{{ device_state.registered_at.strftime('%Y-%m-%d %H:%M') if device_state.registered_at else '-' }}</span>
            </div>
        </div>
        {% else %}
        <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 1rem; opacity: 0.5;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <p>{{ t.get('not_registered', 'Device not registered with cloud') }}</p>
        </div>
        {% endif %}
    </div>

    <div class="card">
        <div class="card-header">{{ t.get('model_info', 'Active Model') }}</div>

        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <span style="color: var(--text-muted);">{{ t.get('model_version', 'Version') }}</span>
                <span style="color: var(--primary-light); font-weight: 500;">ona-cxr-tb-v1.0</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <span style="color: var(--text-muted);">{{ t.get('modality', 'Modality') }}</span>
                <span>CXR (Chest X-ray)</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <span style="color: var(--text-muted);">{{ t.get('target', 'Target') }}</span>
                <span>TB Triage</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <span style="color: var(--text-muted);">{{ t.get('status', 'Status') }}</span>
                <span style="padding: 0.25rem 0.75rem; background: rgba(34, 197, 94, 0.15); color: var(--success); border-radius: 6px; font-size: 0.85rem;">
                    {{ t.get('active', 'Active') }}
                </span>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">{{ t.get('actions', 'Quick Actions') }}</div>

    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="triggerSync()" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            {{ t.get('trigger_sync', 'Sync Now') }}
        </button>
        <button onclick="checkHealth()" class="btn btn-outline">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
            </svg>
            {{ t.get('check_health', 'Health Check') }}
        </button>
        <button onclick="window.location.reload()" class="btn btn-outline">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="1 4 1 10 7 10"></polyline>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
            {{ t.get('refresh', 'Refresh') }}
        </button>
    </div>
</div>

<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">{{ t.get('system_info', 'System Information') }}</div>

    <div style="font-family: 'Monaco', monospace; font-size: 0.85rem; background: var(--bg-secondary); padding: 1rem; border-radius: 8px; color: var(--text-secondary);">
        <div>Edge Agent v0.1.0</div>
        <div>Python 3.11 | FastAPI | SQLite</div>
        <div>Last updated: {{ now.strftime('%Y-%m-%d %H:%M:%S') }} UTC</div>
    </div>
</div>

<script>
async function triggerSync() {
    try {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = 'Syncing...';

        const response = await fetch('/api/sync', { method: 'POST' });
        const data = await response.json();

        alert('Sync complete!\n\nAttempted: ' + data.attempted + '\nSucceeded: ' + data.succeeded + '\nFailed: ' + data.failed);
        window.location.reload();
    } catch (e) {
        alert('Sync error: ' + e.message);
    }
}

async function checkHealth() {
    try {
        const response = await fetch('/health');
        const data = await response.json();
        alert('System Health:\n\n' + JSON.stringify(data, null, 2));
    } catch (e) {
        alert('Health check failed: ' + e.message);
    }
}
</script>
{% endblock %}
